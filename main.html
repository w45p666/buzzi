<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>AI Chatbot</title>
<style>
body{font-family:Arial,sans-serif;margin:0;display:flex;flex-direction:column;height:100vh;background:#2c3e50;color:white;}
header{background:#3498db;padding:10px;display:flex;align-items:center;justify-content:space-between;}
header img{width:40px;height:40px;border-radius:50%;margin-right:10px;}
header button{margin-left:5px;padding:5px 10px;border:none;border-radius:5px;cursor:pointer;font-weight:bold;}
header button:hover{opacity:0.8;}
#chat{flex:1;padding:10px;overflow-y:auto;display:flex;flex-direction:column;gap:10px;}
.message{display:flex;align-items:center;gap:10px;padding:8px 12px;border-radius:10px;max-width:80%;word-wrap:break-word;}
.message.user{background:rgba(46, 204, 113,0.3);align-self:flex-end;}
.message.ai{background:rgba(52, 152, 219,0.3);align-self:flex-start;}
.message img{width:30px;height:30px;border-radius:50%;}
form{display:flex;padding:10px;background:#34495e;}
form input{flex:1;padding:10px;border-radius:5px 0 0 5px;border:none;}
form button{padding:10px 15px;border:none;background:#f39c12;color:white;font-weight:bold;border-radius:0 5px 5px 0;cursor:pointer;}
</style>
</head>
<body>
<header>
  <div style="display:flex;align-items:center;">
    <img id="pfp" src="" alt="PFP">
    <span id="usernameHeader"></span>
  </div>
  <div>
    <button onclick="logout()">Logout</button>
    <button onclick="editProfile()">Edit Profile</button>
  </div>
</header>

<div id="chat"></div>

<form id="chatForm">
  <input id="messageInput" type="text" placeholder="Type your message..." required>
  <button type="submit">Send</button>
</form>

<script>
// Login check
let username = localStorage.getItem("username");
if(!username) window.location.href="index.html";

let users = JSON.parse(localStorage.getItem("users"));
let userData = users[username] || {};

document.getElementById("usernameHeader").innerText = username;
document.getElementById("pfp").src = userData.pfp || "https://via.placeholder.com/40";

let messages = JSON.parse(localStorage.getItem("chatMessages")) || [];

// Render chat
function renderMessages(){
  const chat=document.getElementById("chat");
  chat.innerHTML="";
  messages.forEach(msg=>{
    const div=document.createElement("div");
    div.className="message "+(msg.sender==="user"?"user":"ai");
    div.innerHTML=`<img src="${msg.pfp||'https://via.placeholder.com/30'}"><strong>${msg.sender==="user"?msg.username:"AI"}:</strong> ${msg.text}`;
    chat.appendChild(div);
  });
  chat.scrollTop=chat.scrollHeight;
}

// AI response (simple rule-based)
function getAIResponse(text){
  text=text.toLowerCase();
  if(text.includes("hello") || text.includes("hi")) return "Hello! How can I help you today?";
  if(text.includes("how are you")) return "I'm just a bot, but I'm doing great!";
  if(text.includes("your name")) return "I'm your friendly AI chatbot.";
  return "Sorry, I don't understand. Can you rephrase?";
}

// Send message
document.getElementById("chatForm").addEventListener("submit",e=>{
  e.preventDefault();
  const text=document.getElementById("messageInput").value.trim();
  if(!text) return;

  // Add user message
  messages.push({sender:"user",username,text,pfp:userData.pfp});
  localStorage.setItem("chatMessages",JSON.stringify(messages));
  renderMessages();
  document.getElementById("messageInput").value="";

  // AI reply
  setTimeout(()=>{
    const aiText=getAIResponse(text);
    messages.push({sender:"ai",username:"AI",text,pfp:"https://via.placeholder.com/30"});
    messages[messages.length-1].text = aiText;
    localStorage.setItem("chatMessages",JSON.stringify(messages));
    renderMessages();
  },500);
});

// Edit profile
function editProfile(){
  let newUsername=prompt("Enter new username:",username);
  if(!newUsername) return;
  if(newUsername!==username && users[newUsername]) { alert("Username taken!"); return; }

  let newPassword=prompt("Enter new password (leave blank to keep current):","");
  const fileInput=document.createElement("input");
  fileInput.type="file"; fileInput.accept="image/*";
  fileInput.onchange=()=>{
    const file=fileInput.files[0];
    if(file){
      const reader=new FileReader();
      reader.onload=function(e){ saveProfile(e.target.result); }
      reader.readAsDataURL(file);
    } else saveProfile(userData.pfp);
  };
  fileInput.click();

  function saveProfile(newPfp){
    if(newUsername!==username) delete users[username];
    users[newUsername]={password:newPassword||userData.password,pfp:newPfp};
    localStorage.setItem("users",JSON.stringify(users));
    localStorage.setItem("username",newUsername);

    // Update past messages username & PFP
    messages.forEach(msg=>{
      if(msg.sender==="user" && msg.username===username){
        msg.username=newUsername;
        msg.pfp=newPfp;
      }
    });
    localStorage.setItem("chatMessages",JSON.stringify(messages));

    username=newUsername;
    userData=users[username];
    document.getElementById("usernameHeader").innerText=username;
    document.getElementById("pfp").src=newPfp||"https://via.placeholder.com/40";
    renderMessages();
    alert("Profile updated!");
  }
}

function logout(){
  localStorage.removeItem("username");
  window.location.href="index.html";
}

renderMessages();
</script>
</body>
</html>
